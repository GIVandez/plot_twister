// frames-add.js — логика добавления новых кадров
function initAddFrameButton() {
    const addButton = document.querySelector('.menu-btn'); // Первая кнопка в меню
    
    async function createNewFrame() {
        const store = window.storyboardStore;
        if (!store || !store.newFrame) {
            return;
        }
        
        const projectId = window.currentProjectId || 1;
        const startTime = calculateDefaultStartTime();
        const endTime = calculateDefaultEndTime();
        
        // Create new frame via API
        const result = await store.newFrame(projectId, `Описание нового кадра`, startTime, endTime, null);
        if (result) {
            // Reload and render
            if (window.renderFrames) {
                window.renderFrames();
            }
            // Show info for the new frame
            const frames = store.getFrames();
            const newFrameIndex = frames.length - 1;
            showNewFrameInfo(newFrameIndex);
            
            // Scroll to new frame
            setTimeout(() => {
                const newId = result.frame_id;
                scrollToNewFrame(newId, newFrameIndex);
            }, 100);
        }
    }
    
    function calculateDefaultStartTime() {
        const store = window.storyboardStore;
        if (!store || store.getFrameCount() === 0) {
            return 0; // Первый кадр начинается с 0
        }
        
        // Новый кадр начинается с конца последнего кадра
        const lastFrame = store.getFrameByIndex(store.getFrameCount() - 1);
        return lastFrame ? lastFrame.end : 0;
    }
    
    function calculateDefaultEndTime() {
        // Новый кадр длится 15 секунд по умолчанию
        const startTime = calculateDefaultStartTime();
        return startTime + 15;
    }
    
    function showNewFrameInfo(frameIndex) {
        const store = window.storyboardStore;
        if (!store) return;
        const frameData = store.getFrameByIndex(frameIndex);
        
        if (!frameData) return;
        
        // Скрываем страницу сценария если она открыта
        if (window.hideScriptPage) {
            window.hideScriptPage();
        }
        
        // Показываем информацию о кадре
        if (window.showFrameInfo) {
            window.showFrameInfo(frameData);
        }
        
        // УБРАНО: автоматическое выделение нового кадра
        // Раньше здесь выполнялся setTimeout, который добавлял класс 'frame-selected' к новому кадру.
    }
    
    function scrollToNewFrame(frameId, frameIndex) {
        const container = document.getElementById('framesContainer');
        const frames = container.querySelectorAll('.frame');
        
        // Находим соответствующий DOM-элемент
        const newFrameElement = frames[frameIndex];
        if (!newFrameElement) return;
        
        // Прокручиваем к новому кадру
        newFrameElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
        });
    }
    
    // Добавляем обработчик клика на кнопку создания кадра
    if (addButton) {
        addButton.addEventListener('click', createNewFrame);
    } else {
        
    }

    // --- Инициализация кнопки "Сохранить" ---
    const saveButton = document.querySelector('.save-data-btn');
    function saveStoryboardDataToFile() {
        const data = window.storyboardData;
        if (!data) {
            alert('Нет данных для сохранения');
            return;
        }
        const header = '// autogenerated by app\n';
        const content = header + 'window.storyboardData = ' + JSON.stringify(data, null, 2) + ';';
        const blob = new Blob([content], { type: 'application/javascript;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'storyboard-data.js';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert('Файл storyboard-data.js подготовлен к скачиванию.');
    }

    if (saveButton) {
        saveButton.addEventListener('click', saveStoryboardDataToFile);
    }

    // Экспорт для консоли/других модулей
    window.saveStoryboardData = saveStoryboardDataToFile;
}

window.initAddFrameButton = initAddFrameButton;