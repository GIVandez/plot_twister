// frames-add.js — логика добавления новых кадров
function initAddFrameButton() {
    const addButton = document.querySelector('.menu-btn'); // Первая кнопка в меню
    
    function createNewFrame() {
        const store = window.storyboardStore;
        if (!store) {
            return;
        }
        // Находим максимальный ID среди существующих кадров
        const newId = store.getNextFrameId();
        
        // Создаем новый кадр с данными по умолчанию
        const newFrame = {
            id: newId,
            image: `IMG_${String(newId).padStart(3, '0')}`,
            description: `Описание нового кадра ${newId}`,
            start: calculateDefaultStartTime(),
            end: calculateDefaultEndTime(),
            shotSize: "Medium Shot", // значение по умолчанию
            connectedPage: null // нет привязанной страницы
        };
        
        // Сохраняем текущий скролл контейнера перед перерисовкой,
        // чтобы предотвратить кратковременную прокрутку вверх
        const container = document.getElementById('framesContainer');
        const prevScroll = container ? container.scrollTop : null;

        // Добавляем новый кадр в данные и перерисовываем кадры
        const newFrameIndex = store.addFrame(newFrame);
        if (window.renderFrames) {
            window.renderFrames();
        }

        // Восстанавливаем прежний скролл, если он был сохранён
        if (container && prevScroll != null) {
            container.scrollTop = prevScroll;
        }

        const indexForInfo = typeof newFrameIndex === 'number' ? newFrameIndex : store.getFrameCount() - 1;
        
        // Показываем информацию о новом кадре в правой панели
        showNewFrameInfo(indexForInfo);
        
        // Прокручиваем к новому кадру (оставляем небольшую задержку для устойчивости)
        setTimeout(() => {
            scrollToNewFrame(newId, indexForInfo);
        }, 100);
    }
    
    function calculateDefaultStartTime() {
        const store = window.storyboardStore;
        if (!store || store.getFrameCount() === 0) {
            return 0; // Первый кадр начинается с 0
        }
        
        // Новый кадр начинается с конца последнего кадра
        const lastFrame = store.getFrameByIndex(store.getFrameCount() - 1);
        return lastFrame ? lastFrame.end : 0;
    }
    
    function calculateDefaultEndTime() {
        // Новый кадр длится 15 секунд по умолчанию
        const startTime = calculateDefaultStartTime();
        return startTime + 15;
    }
    
    function showNewFrameInfo(frameIndex) {
        const store = window.storyboardStore;
        if (!store) return;
        const frameData = store.getFrameByIndex(frameIndex);
        
        if (!frameData) return;
        
        // Скрываем страницу сценария если она открыта
        if (window.hideScriptPage) {
            window.hideScriptPage();
        }
        
        // Показываем информацию о кадре
        if (window.showFrameInfo) {
            window.showFrameInfo(frameData);
        }
        
        // УБРАНО: автоматическое выделение нового кадра
        // Раньше здесь выполнялся setTimeout, который добавлял класс 'frame-selected' к новому кадру.
    }
    
    function scrollToNewFrame(frameId, frameIndex) {
        const container = document.getElementById('framesContainer');
        const frames = container.querySelectorAll('.frame');
        
        // Находим соответствующий DOM-элемент
        const newFrameElement = frames[frameIndex];
        if (!newFrameElement) return;
        
        // Прокручиваем к новому кадру
        newFrameElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
        });
    }
    
    // Добавляем обработчик клика на кнопку создания кадра
    if (addButton) {
        addButton.addEventListener('click', createNewFrame);
    } else {
        
    }

    // --- Инициализация кнопки "Сохранить" ---
    const saveButton = document.querySelector('.save-data-btn');
    function saveStoryboardDataToFile() {
        const data = window.storyboardData;
        if (!data) {
            alert('Нет данных для сохранения');
            return;
        }
        const header = '// autogenerated by app\n';
        const content = header + 'window.storyboardData = ' + JSON.stringify(data, null, 2) + ';';
        const blob = new Blob([content], { type: 'application/javascript;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'storyboard-data.js';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert('Файл storyboard-data.js подготовлен к скачиванию.');
    }

    if (saveButton) {
        saveButton.addEventListener('click', saveStoryboardDataToFile);
    }

    // Экспорт для консоли/других модулей
    window.saveStoryboardData = saveStoryboardDataToFile;
}

window.initAddFrameButton = initAddFrameButton;